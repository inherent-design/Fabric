[tools]
cmake = "latest"
codeql = { version = "latest", bin_path = "codeql", platforms = """
[linux-x64]
asset_pattern = "codeql-linux64.zip"

[macos-arm64]
asset_pattern = "codeql-osx64.zip"

[macos-x64]
asset_pattern = "codeql-osx64.zip"

[windows-x64]
asset_pattern = "codeql-win64.zip"
""" }
ninja = "latest"

# LLVM: Homebrew manages install (macOS ABI compatibility),
# mise scopes the environment per-project via [env] below.
[env]
_.path = ["/opt/homebrew/opt/llvm/bin"]
CC = "clang"
CXX = "clang++"
CPPFLAGS = "-I/opt/homebrew/opt/llvm/include"
LDFLAGS = "-L/opt/homebrew/opt/llvm/lib"
CPM_SOURCE_CACHE = "~/.cache/CPM"

#
# Build
#

[tasks.clean]
description = "Remove build artifacts"
run = "sh tasks/clean.sh"

[tasks.build]
alias = "b"
description = "Configure and build (Debug)"
run = "sh tasks/build.sh"

[tasks."build:release"]
alias = "br"
description = "Configure and build (Release)"
run = "BUILD_PRESET=dev-release sh tasks/build.sh"

#
# Lint & Format
#

[tasks.format]
alias = "fmt"
description = "Check clang-format on source files"
run = "sh tasks/format.sh"

[tasks."format:fix"]
description = "Auto-format source files"
run = "FORMAT_FIX=1 sh tasks/format.sh"

[tasks.lint]
description = "Run clang-tidy on all source files (slow)"
run = "sh tasks/lint.sh"

[tasks."lint:changed"]
description = "Run clang-tidy on git-dirty files only (fast)"
run = "LINT_CHANGED=1 sh tasks/lint.sh"

[tasks."lint:fix"]
alias = "fix"
description = "Run clang-tidy with auto-fix (CAUTION: can break cross-file refs)"
run = "LINT_FIX=1 LINT_CHANGED=1 sh tasks/lint.sh"

[tasks.cppcheck]
description = "Run cppcheck static analysis"
run = "sh tasks/cppcheck.sh"

#
# Test
#

[tasks.test]
alias = "t"
description = "Run unit tests"
depends = ["build"]
run = "sh tasks/test.sh"

[tasks."test:e2e"]
description = "Run E2E tests (slow)"
depends = ["build"]
run = "TEST_SUITE=e2e sh tasks/test.sh"

[tasks."test:all"]
description = "Run unit + E2E tests"
depends = ["build"]
run = "TEST_SUITE=all sh tasks/test.sh"

[tasks."test:filter"]
alias = "tf"
description = "Run unit tests with gtest filter"
depends = ["build"]
usage = 'arg "filter" help="gtest --gtest_filter value"'
run = "TEST_FILTER=\"{{arg(name='filter')}}\" sh tasks/test.sh"

#
# Analysis
#

[tasks.sanitize]
description = "Build and test with ASan + UBSan"
run = "sh tasks/sanitize.sh"

[tasks."sanitize:tsan"]
description = "Build and test with ThreadSanitizer"
run = "SANITIZE_PRESET=ci-tsan sh tasks/sanitize.sh"

[tasks.coverage]
description = "Build with coverage and generate lcov report"
run = "sh tasks/coverage.sh"

[tasks.codeql]
description = "Run CodeQL security analysis locally"
depends = ["build"]
run = "sh tasks/codeql.sh"
